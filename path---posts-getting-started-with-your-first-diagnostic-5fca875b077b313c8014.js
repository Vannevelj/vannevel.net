webpackJsonp([0x63aaffe0fe7e],{431:function(n,a){n.exports={data:{site:{siteMetadata:{title:"To kill a mocking bug",subtitle:"Unearthing curious .NET behaviour",author:{name:"Jeroen Vannevel",twitter:"VannevelJeroen"},disqusShortname:"",url:"https://vannevel.net"}},markdownRemark:{id:"C:/Source/vannevelj.github.io/lumen/src/pages/articles/2015-05-03---Getting-Started-With-Your-First-Diagnostic/index.md absPath of file >>> MarkdownRemark",html:'<h1>Introduction</h1>\n<p>With the release of Visual Studio 2015 RC, we also received the pretty much final implementation of the Diagnostics implementation. This SDK allows us to create our own diagnostics to help us write proper code that’s being verified against those rules in real-time: you don’t have to perform the verification at a separate build-step. What’s more is that we can combine that with a code fix: a shortcut integrated in Visual Studio that provides us a solution to what we determine to be a problem.</p>\n<p>This might sound a little abstract but if you’ve been using Visual Studio (and/or Resharper) then you know what I mean: have you ever written your classname as <code class="language-text">myClass</code> rather than <code class="language-text">MyClass</code>? This is a violation of the C# naming conventions and visual studio will warn you about it and provide you a quick-fix to turn it into a proper capitalized word. This is exactly the behaviour we can create and which is integrated seemlessly in Visual Studio.</p>\n<p>I gave this a go exactly 1 year ago but decided against continuing because there wasn’t a final version of it yet and it was really cumbersome to test. That combined with the fact that it was hardly usable (not many people had Visual Studio 2015 yet) made me wait until it had matured and was properly supported. Luckily, it seems that time has finally come.</p>\n<h1>The setup</h1>\n<p>In order to get started you need a few things installed:</p>\n<ul>\n<li><a href="https://www.visualstudio.com/en-us/downloads/visual-studio-2015-downloads-vs.aspx">Visual Studio 2015 RC</a></li>\n<li><a href="https://www.visualstudio.com/en-us/downloads/visual-studio-2015-downloads-vs.aspx">Visual Studio 2015 RC SDK</a> (Same link as above but at the bottom of the page, go to Additional Tools -> Visual Studio 2015 SDK RC)</li>\n<li><a href="https://visualstudiogallery.msdn.microsoft.com/e2e07e91-9d0b-4944-ba40-e86bcbec1599">.NET Compiler Platform SDK Templates for RC</a>\nYou will notice that each of these downloads are specific for the RC version, which is what I’m using at the time of writing. Make sure that you don’t mix up CTP-X, RC and RTM versions since that is bound to create issues.</li>\n</ul>\n<h1>Creating an Analyzer</h1>\n<p>Even though the official template says “Diagnostic and CodeFix”, the term “Analyzer” is used equally, if not more, as “diagnostic”. I don’t believe there are hard conventions on this yet so use what you feel more natural. I personally prefer to append “Analyzer” to my.. diagnostics.</p>\n<p>In Visual Studio, create a new project (and a solution if needed) using the “Diagnostic with Code Fix (NuGet + VSIX)” template, found under “Extensibility”. This immediately indicates a very useful feature: you will be able to distribute your analyzers using NuGet and/or you can choose to distribute them as an installable extension instead. This makes it very easy to deploy in your environment and share it with others should you want to.</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/createproject-18efddcd67357ae81282c003729762f1-a6608.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 955px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 69.10994764397905%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACTElEQVQ4y32Th3LiMBCG/f5vdi0JARccDMa9yFVyAZf/ViJhSC5zmtlZrVb76dda1vwgQRBliFOGKGHKx0mOKM6QZoWKD8czjq6n4ohyYRjQeoEsZ7TGkKRyfwpr/wbNtFzsDBeuz3A853DcFGcvREwbclYRnMHzI3AxYJpXtLwnUArejQoigXXDKd+j60donHPEUYRhGCCHEB10Xae4B+ctlmXGui7K5FiXBUM/YJlnBL4P93TC2XWRZzkkS1toQ11VqOtaFQzDiMPBAW9blGWJcRzxOGYCycJ1XSFrZTxN0z1WwDwv4LqhKujp9CAMUdEhWZahYAW6rqP1HtfrVfmyrDBeLgQhxQ+H3YGMUZ88Xy12VGCYplqT0KZplG9JsVQr4awo1MGLVEUm1d2BUnLXCXUNOS6kwrZt1QbBhVJ0ITWPV5bwD4jU+Akor1GVsofNO3Cir+yjE0IVyp5+qJB1NwGdKlZX/qqwp2SaJKpfE8Fl6jrNKvm5Q/ik6F97B0b0QOOsQdtNqNoLGnG9l07TSj2d0Q83E708CP8ZK7SDm+HglXDITn6Bc0h/AKtRlPRsqgFp3iNlvfJJ1qHh9GH6C1gpKK4p19J+gawQNKd3+OvJws9nB+Zbis2rpczcn2BYR/pLClS1QFFxgguUNGclVzDTDvDjt45Xw8dun2BrxeRjaC/bkwLK4EV3sTE8mIeYLIHlpN/a/pgRIMSfjYun7RnPOw+6ncIgUZrtxDfAW0QWKzPs8MGib+Y3v7MCbHUHr1sTm62FF7rdXxTKJkJUlsF0AAAAAElFTkSuQmCC\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="Create the project"\n        title=""\n        src="/static/createproject-18efddcd67357ae81282c003729762f1-a6608.png"\n        srcset="/static/createproject-18efddcd67357ae81282c003729762f1-8fb2e.png 240w,\n/static/createproject-18efddcd67357ae81282c003729762f1-9f56d.png 480w,\n/static/createproject-18efddcd67357ae81282c003729762f1-a6608.png 955w"\n        sizes="(max-width: 955px) 100vw, 955px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Now on to the real work: we will create an analyzer that shows a warning when we throw an <code class="language-text">ArgumentException</code> without passing a parameter to it. The use of this is that we will make sure that we’re never just going to throw such an exception without specifying what argument is being annoying in the first place.</p>\n<p>After your template is created you will notice 3 projects in the solution: a portable class library which contains your analyzers and code fix providers, a test project and an extension project. You can ignore the latter one and we’ll focus on the first two.</p>\n<p>When you look at your analyzer you see an entire example for you to start from. The nature of the diagnostic we will create however is such that we will analyze a syntax node, not a symbol. The code we implement is very straightforward:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">DiagnosticAnalyzer</span><span class="token punctuation">(</span>LanguageNames<span class="token punctuation">.</span>CSharp<span class="token punctuation">)</span><span class="token punctuation">]</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmptyArgumentExceptionAnalyzer</span> <span class="token punctuation">:</span> <span class="token class-name">DiagnosticAnalyzer</span>\n<span class="token punctuation">{</span>\n   <span class="token keyword">public</span> <span class="token keyword">const</span> <span class="token keyword">string</span> DiagnosticId <span class="token operator">=</span> <span class="token string">"EmptyArgumentExceptionAnalyzer"</span><span class="token punctuation">;</span>\n   <span class="token keyword">internal</span> <span class="token keyword">const</span> <span class="token keyword">string</span> Title <span class="token operator">=</span> <span class="token string">"Verifies whether an ArgumentException is thrown with a message."</span><span class="token punctuation">;</span>\n   <span class="token keyword">internal</span> <span class="token keyword">const</span> <span class="token keyword">string</span> MessageFormat <span class="token operator">=</span> <span class="token string">"ArgumentException is thrown without a message."</span><span class="token punctuation">;</span>\n   <span class="token keyword">internal</span> <span class="token keyword">const</span> <span class="token keyword">string</span> Category <span class="token operator">=</span> <span class="token string">"Exceptions"</span><span class="token punctuation">;</span>\n   <span class="token keyword">internal</span> <span class="token keyword">const</span> <span class="token class-name">DiagnosticSeverity</span> Severity <span class="token operator">=</span> DiagnosticSeverity<span class="token punctuation">.</span>Warning<span class="token punctuation">;</span>\n   <span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token class-name">DiagnosticDescriptor</span> Rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DiagnosticDescriptor</span><span class="token punctuation">(</span>DiagnosticId<span class="token punctuation">,</span> Title<span class="token punctuation">,</span> MessageFormat<span class="token punctuation">,</span> Category<span class="token punctuation">,</span> Severity<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token keyword">public</span> <span class="token keyword">override</span> ImmutableArray<span class="token operator">&lt;</span>DiagnosticDescriptor<span class="token operator">></span> SupportedDiagnostics <span class="token operator">=</span><span class="token operator">></span> ImmutableArray<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>Rule<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n   <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token class-name">AnalysisContext</span> context<span class="token punctuation">)</span>\n   <span class="token punctuation">{</span>\n       context<span class="token punctuation">.</span><span class="token function">RegisterSyntaxNodeAction</span><span class="token punctuation">(</span>AnalyzeSyntaxNode<span class="token punctuation">,</span> SyntaxKind<span class="token punctuation">.</span>ThrowStatement<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">AnalyzeSyntaxNode</span><span class="token punctuation">(</span><span class="token class-name">SyntaxNodeAnalysisContext</span> context<span class="token punctuation">)</span>\n   <span class="token punctuation">{</span>\n       <span class="token keyword">var</span> throwStatement <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token class-name">Node</span> <span class="token keyword">as</span> ThrowStatementSyntax<span class="token punctuation">;</span>\n       <span class="token keyword">if</span> <span class="token punctuation">(</span>throwStatement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n       <span class="token punctuation">{</span>\n           <span class="token keyword">return</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span>\n\n       <span class="token keyword">var</span> expression <span class="token operator">=</span> throwStatement<span class="token punctuation">.</span><span class="token class-name">Expression</span> <span class="token keyword">as</span> ObjectCreationExpressionSyntax<span class="token punctuation">;</span>\n       <span class="token keyword">if</span> <span class="token punctuation">(</span>expression <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n       <span class="token punctuation">{</span>\n           <span class="token keyword">return</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span>\n\n       <span class="token keyword">var</span> symbolInformation <span class="token operator">=</span> context<span class="token punctuation">.</span>SemanticModel<span class="token punctuation">.</span><span class="token function">GetSymbolInfo</span><span class="token punctuation">(</span>expression<span class="token punctuation">.</span>Type<span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token keyword">if</span> <span class="token punctuation">(</span>symbolInformation<span class="token punctuation">.</span>Symbol<span class="token punctuation">.</span>MetadataName <span class="token operator">!=</span> <span class="token string">"ArgumentException"</span><span class="token punctuation">)</span>\n       <span class="token punctuation">{</span>\n           <span class="token keyword">return</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span>\n\n       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expression<span class="token punctuation">.</span>ArgumentList<span class="token punctuation">.</span><span class="token function">ChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n       <span class="token punctuation">{</span>\n           context<span class="token punctuation">.</span><span class="token function">ReportDiagnostic</span><span class="token punctuation">(</span>Diagnostic<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>Rule<span class="token punctuation">,</span> expression<span class="token punctuation">.</span><span class="token function">GetLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n       <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>I’ve disregarded globalization because it is an extra hurdle to readability and I don’t expect my project to ever become popular enough that it warrants different languages to be supported. Aside from that you’ll notice that I also used a lovely expression Body for the <code class="language-text">SupportedDiagnostics</code> method.</p>\n<p>The first thing I did was register my analyzer on a a syntax node, a <code class="language-text">throw</code> statement to be precise. This evidentely means that each time a <code class="language-text">throw</code> statement is encountered when the tree is walked through, my analyzer will execute.</p>\n<p>The actual implementation is very straightforward:</p>\n<ul>\n<li>Verify the node is a throw statement</li>\n<li>Verify the expression creates a new object</li>\n<li>Verify the new object is of type ArgumentException</li>\n<li>Verify there are no arguments passed to the constructor\nAnd that’s it. If these 4 conditions are true, I believe there to be an empty <code class="language-text">ArgumentException</code> call and I report a warning on that location.</li>\n</ul>\n<h1>Testing the analyzer</h1>\n<p>If you now set the Vsix project as your startup project and press the big green “Start” button, a new Visual Studio instance will be launched. Use it to create a new project and you will notice that your analyzer is included. You can now let yourself loose on all sorts of scenarios involving <code class="language-text">ArgumentExceptions</code>!</p>\n<p>However I wouldn’t be me if I didn’t look into unit testing instead. Luckily, this is very easily done with this release. In fact, it’s so easy that there’s really not much looking into: you create a test class that inherits from <code class="language-text">CodeFixVerifier</code>, override the <code class="language-text">GetCSharpDiagnosticAnalyzer</code> and <code class="language-text">GetCSharpCodeFixProvider</code> as needed, you write source code in plain text and you use the helper functions <code class="language-text">VerifyCSharpDiagnostic</code> and <code class="language-text">VerifyCSharpCodeFix</code> to assert whether or not a diagnostic/code fix should occur at the given position. If nothing should occur you just pass in the source code as a string and if you do expect something, you pass in a <code class="language-text">DiagnosticResult</code>.</p>\n<p>In code:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">TestClass</span><span class="token punctuation">]</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnitTest</span> <span class="token punctuation">:</span> <span class="token class-name">CodeFixVerifier</span>\n<span class="token punctuation">{</span>\n   <span class="token punctuation">[</span><span class="token class-name">TestMethod</span><span class="token punctuation">]</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">EmptyArgumentExceptionAnalyzer_WithEmptyArgument_InvokesWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n   <span class="token punctuation">{</span>\n       <span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token string">@"\nusing System;\nusing System.Text;\n\nnamespace ConsoleApplication1\n{\n   class MyClass\n   {\n       void Method(string input)\n       {\n           throw new ArgumentException();\n       }\n   }\n}"</span><span class="token punctuation">;</span>\n\n       <span class="token keyword">var</span> expected <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DiagnosticResult</span>\n       <span class="token punctuation">{</span>\n           Id <span class="token operator">=</span> EmptyArgumentExceptionAnalyzerAnalyzer<span class="token punctuation">.</span>DiagnosticId<span class="token punctuation">,</span>\n           Message <span class="token operator">=</span> EmptyArgumentExceptionAnalyzerAnalyzer<span class="token punctuation">.</span>MessageFormat<span class="token punctuation">,</span>\n           Severity <span class="token operator">=</span> EmptyArgumentExceptionAnalyzerAnalyzer<span class="token punctuation">.</span>Severity<span class="token punctuation">,</span>\n           Locations <span class="token operator">=</span>\n               <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>\n               <span class="token punctuation">{</span>\n                   <span class="token keyword">new</span> <span class="token class-name">DiagnosticResultLocation</span><span class="token punctuation">(</span><span class="token string">"Test0.cs"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span>\n               <span class="token punctuation">}</span>\n       <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n       <span class="token function">VerifyCSharpDiagnostic</span><span class="token punctuation">(</span>test<span class="token punctuation">,</span> expected<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token punctuation">[</span><span class="token class-name">TestMethod</span><span class="token punctuation">]</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">EmptyArgumentExceptionAnalyzer_WithArgument_DoesNotInvokeWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n   <span class="token punctuation">{</span>\n       <span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token string">@"\nusing System;\nusing System.Text;\n\nnamespace ConsoleApplication1\n{\n   class MyClass\n   {\n       void Method(string input)\n       {\n           throw new ArgumentException(input);\n       }\n   }\n}"</span><span class="token punctuation">;</span>\n       <span class="token function">VerifyCSharpDiagnostic</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token punctuation">[</span><span class="token class-name">TestMethod</span><span class="token punctuation">]</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">EmptyArgumentExceptionAnalyzer_WithDumbRethrowStatement_DoesNotInvokeWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n   <span class="token punctuation">{</span>\n       <span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token string">@"\nusing System;\nusing System.Text;\n\nnamespace ConsoleApplication1\n{\n   class MyClass\n   {\n       void Method(string input)\n       {\n           try { }\n           catch (ArgumentException e) { throw e; }\n       }\n   }\n}"</span><span class="token punctuation">;</span>\n\n       <span class="token function">VerifyCSharpDiagnostic</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token punctuation">[</span><span class="token class-name">TestMethod</span><span class="token punctuation">]</span>\n   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">EmptyArgumentExceptionAnalyzer_WithRethrowStatement_DoesNotInvokeWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n   <span class="token punctuation">{</span>\n       <span class="token keyword">var</span> test <span class="token operator">=</span> <span class="token string">@"\nusing System;\nusing System.Text;\n\nnamespace ConsoleApplication1\n{\n   class MyClass\n   {\n       void Method(string input)\n       {\n           try { }\n           catch (ArgumentException e) { throw; }\n       }\n   }\n}"</span><span class="token punctuation">;</span>\n\n       <span class="token function">VerifyCSharpDiagnostic</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n\n   <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token class-name">DiagnosticAnalyzer</span> <span class="token function">GetCSharpDiagnosticAnalyzer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n   <span class="token punctuation">{</span>\n       <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EmptyArgumentExceptionAnalyzer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>That’s how easy it now is to create your own slim ReSharper. Your code is evaluated against your rules as you type, you can write them yourself very easily and you can export them as needed. I will definitely port the few analyzers I created as a test last year and expand it with many others I can think of and I encourage you to do the same (or contribute).</p>\n<p>For more information on how to get started with these analyzers I recommend a couple of resources:</p>\n<ul>\n<li><a href="http://channel9.msdn.com/Series/ConnectOn-Demand/225">http://channel9.msdn.com/Series/ConnectOn-Demand/225</a></li>\n<li><a href="https://www.wintellectnow.com/videos/watch?videoid=writing-roslyn-analyzers-and-code-fixes">https://www.wintellectnow.com/videos/watch?videoid=writing-roslyn-analyzers-and-code-fixes</a></li>\n</ul>',fields:{tagSlugs:["/tags/c/","/tags/roslyn/","/tags/visual-studio/","/tags/diagnostics/","/tags/unit-testing/"]},frontmatter:{title:"Getting started with your first diagnostic",tags:["C#","Roslyn","Visual Studio","Diagnostics","Unit Testing"],date:"2015-05-03T00:00:00.000Z",description:"With the release of Visual Studio 2015 RC, we also received the pretty much final implementation of the Diagnostics implementation. This SDK allows us to create our own diagnostics to help us write proper code that’s being verified against those rules in real-time: you don’t have to perform the verification at a separate build-step. What’s more is that we can combine that with a code fix: a shortcut integrated in Visual Studio that provides us a solution to what we determine to be a problem."}}},pathContext:{slug:"/posts/getting-started-with-your-first-diagnostic/"}}}});
//# sourceMappingURL=path---posts-getting-started-with-your-first-diagnostic-5fca875b077b313c8014.js.map
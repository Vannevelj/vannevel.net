webpackJsonp([0x7266de6fed4c],{451:function(n,s){n.exports={data:{site:{siteMetadata:{title:"To kill a mocking bug",subtitle:"Unearthing curious .NET behaviour",author:{name:"Jeroen Vannevel",twitter:"VannevelJeroen"},disqusShortname:"",url:"https://vannevel.net"}},markdownRemark:{id:"C:/Source/vannevelj.github.io/lumen/src/pages/articles/2015-02-26---Properly-Testing-Entity-Framework-With-Effort/index.md absPath of file >>> MarkdownRemark",html:'<h1>Introduction</h1>\n<p>If you have ever needed to use a database in C# then chances are you ended up with Entity Framework as an ORM layer. It allows you to query the database with LINQ rather than explicit SQL queries making for a much more comfortable data layer. However if you’re also the kind of person that likes (has?) to write tests then you might have noticed that the DbContext class is rather annoying to work around.</p>\n<p>Personally I am not a fan of mocking at all: it requires a lot of setup work which pollutes the test and it makes your code brittle (if the mock is configured to return X but you change the implementation to return Y, the tests will still work despite the discrepancy with the actual implementation).</p>\n<p>The idea behind what you will read is straightforward: instead of using an actual database hosted locally or on Azure, we’ll create one in-memory for each test. This allows us to test each layer of our project in a fast manner without having to resort to creating a fake implementation of our actual code. There is a thin line between unit testing and integration testing that we may cross here but I don’t consider this a problem: fast, reliable and clean tests get precedence over ideologism in any scenario.</p>\n<p>The first part of this article will take you through the steps to setup a generic project that uses Entity-Framework so if you want to go straight to implementing your tests, skip to part 2.</p>\n<p>Without further ado, let me take you through the process of getting Entity-Framework in a testable state.</p>\n<h1>Setting up the solution</h1>\n<p>Create a new solution with a class library (“Database”) and a unit test project.</p>\n<p>The former will be where we talk to the database and the latter will contain our tests.</p>\n<h2>Add the <code class="language-text">Book</code> model and the <code class="language-text">IBookRepository</code> interface.</h2>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Book</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token function">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token function">Book</span><span class="token punctuation">(</span><span class="token keyword">string</span> title<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        Title <span class="token operator">=</span> title<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">int</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n    <span class="token keyword">public</span> <span class="token keyword">string</span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IBookRepository</span>\n<span class="token punctuation">{</span>\n    <span class="token class-name">Book</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">void</span> <span class="token function">Insert</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h2>Install Entity-Framework in your class library project and add your <code class="language-text">DbContext</code> implementation.</h2>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LibraryContext</span> <span class="token punctuation">:</span> <span class="token class-name">DbContext</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token function">LibraryContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> DbSet<span class="token operator">&lt;</span>Book<span class="token operator">></span> Books <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LibraryContext</span> <span class="token punctuation">:</span> <span class="token class-name">DbContext</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token function">LibraryContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> DbSet<span class="token operator">&lt;</span>Book<span class="token operator">></span> Books <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h2>Execute <code class="language-text">Enable-Migrations</code> on your class library project.</h2>\n<p>Entity-Framework Migrations allows us to keep the database up-to-date with the model used in our code. You can find more information about this here.</p>\n<h2>Implement <code class="language-text">IBookRepository</code>.</h2>\n<p>This will be a very basic implementation. I’m using constructor injection to pass in the right context to make sure the caller always passes in an object (for our own sake, let’s assume people don’t pass in null values.</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookRepository</span> <span class="token punctuation">:</span> <span class="token class-name">IBookRepository</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">LibraryContext</span> _context<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token function">BookRepository</span><span class="token punctuation">(</span><span class="token class-name">LibraryContext</span> context<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        _context <span class="token operator">=</span> context<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">Book</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> _context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span>Id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Insert</span><span class="token punctuation">(</span><span class="token class-name">Book</span> book<span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        _context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        _context<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h1>Configuring the project for testing</h1>\n<h2>Create the Unit Test project.</h2>\n<p>Add a reference to your class library project so you can use the <code class="language-text">LibraryContext</code> object you created.</p>\n<h2>Install Effort.EF6 in your test project.</h2>\n<p>This library contains the magic that makes all this possible: Effort will allow us to easily create a new database in-memory. You’ll notice that it adds additional references to Entity-Framework and NMemory which basically describes its purpose already.</p>\n<h2>Create an additional <code class="language-text">LibraryContext</code> constructor.</h2>\n<p>This constructor will allow us to pass in the connection created by Effort. Note the importance of the second parameter to be true: “The connection will not be disposed when the context is disposed if <code class="language-text">contextOwnsConnection</code> is false“. Obviously we don’t want that connection to linger around when the context is already disposed, that would mean a lot of left-over trash. You’ll notice soon that the connection we create is explicitly chosen to be disposed after every test run, guaranteeing a clean test each time we run it.</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token function">LibraryContext</span><span class="token punctuation">(</span><span class="token class-name">DbConnection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h2>Implement tests.</h2>\n<p>These three tests are basic and show how little you actually have to change your testing approach to use this. What catches the eye is <code class="language-text">DbConnectionFactory.CreateTransient()</code>. The corresponding documentation is clear enough:</p>\n<p>“Creates a <code class="language-text">DbConnection</code> object that rely on an in-memory database instance that lives during the connection object lifecycle. If the connection object is disposed or garbage collected, then underlying database will be garbage collected too.”</p>\n<p>You can see that our connection object is created in the <code class="language-text">Initialize()</code> method and passed to the <code class="language-text">LibrayContext</code> and subsequently the <code class="language-text">BookRepository</code>. In essence this means that, since the connection is local and the context and repository are overwritten after each test, the connection and database will be disposed after each test. This results in entirely separated database instances for each test.</p>\n<p>Note that for the tests I used FluentAssertions.</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">TestClass</span><span class="token punctuation">]</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookRepositoryTests</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token class-name">LibraryContext</span> _context<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> <span class="token class-name">IBookRepository</span> _repository<span class="token punctuation">;</span>\n\n    <span class="token punctuation">[</span><span class="token class-name">TestInitialize</span><span class="token punctuation">]</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token keyword">var</span> connection <span class="token operator">=</span> DbConnectionFactory<span class="token punctuation">.</span><span class="token function">CreateTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        _context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LibraryContext</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        _repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookRepository</span><span class="token punctuation">(</span>_context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token punctuation">[</span><span class="token class-name">TestMethod</span><span class="token punctuation">]</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">GetBook_WithNonExistingId_ReturnsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token comment">// Arrange</span>\n        <span class="token keyword">const</span> <span class="token keyword">int</span> nonExistingId <span class="token operator">=</span> <span class="token number">155</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// Act</span>\n        <span class="token keyword">var</span> book <span class="token operator">=</span> _repository<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>nonExistingId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// Assert</span>\n        book<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token punctuation">[</span><span class="token class-name">TestMethod</span><span class="token punctuation">]</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">InsertBook_AddsBookToDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token comment">// Arrange</span>\n        <span class="token keyword">const</span> <span class="token keyword">string</span> title <span class="token operator">=</span> <span class="token string">"To kill a mocking bird"</span><span class="token punctuation">;</span>\n        <span class="token keyword">var</span> book <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Book</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// Act</span>\n        _repository<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// Assert</span>\n        _context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HaveCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        _context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NotBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        _context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Title<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Be</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token punctuation">[</span><span class="token class-name">TestMethod</span><span class="token punctuation">]</span>\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">GetBook_WithExistingId_ReturnsBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token comment">// Arrange</span>\n        <span class="token keyword">var</span> book <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Book</span><span class="token punctuation">(</span><span class="token string">"To kill a mocking bird"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        _repository<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// Act</span>\n        <span class="token keyword">var</span> retrievedBook <span class="token operator">=</span> _repository<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>book<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// Assert</span>\n        book<span class="token punctuation">.</span>Title<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Be</span><span class="token punctuation">(</span>retrievedBook<span class="token punctuation">.</span>Title<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        book<span class="token punctuation">.</span>Id<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Be</span><span class="token punctuation">(</span>retrievedBook<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h2>InvalidOperationException</h2>\n<p>Of course, there just had to be problems along the way otherwise anyone would be using this already. The first one you’ll get it this:</p>\n<p>“<code class="language-text">System.InvalidOperationException</code>: Migrations is enabled for context ‘<code class="language-text">LibraryContext</code>’ but the database does not exist or contains no mapped tables. Use Migrations to create the database and its tables, for example by running the ‘<code class="language-text">Update-Database</code>’ command from the Package Manager Console.”</p>\n<p>Evidently this is irrelevant to us since the entire idea behind our approach is that we don’t have a database to start with but instead create it each test. Entity-Framework notices it has migrations planned because it sees the configuration present in our Migrations folder so we can use this information to work around the issue: simply create a new Class Library project and move your Migrations folder to it. If you execute your tests again you will notice that they now all pass.</p>\n<h2>Didn’t you just break the Migration configuration?</h2>\n<p>Yes, I did. You can verify this (and do so to follow along) by adding a Console Application project and adding a reference to the “Database” project and Entity-Framework.\nAfterwards, add some test code to use as your actual implementation:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LibraryContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> bookRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookRepository</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    bookRepository<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Book</span><span class="token punctuation">(</span><span class="token string">"One flew over the cuckoo\'s nest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">"\\n"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span>Title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    Console<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>If you now test your program with an actual implementation you’ll notice you might receive an <code class="language-text">InvalidOperationException</code>. This happens because you don’t have a reference to EntityFramework.SqlServer in your console application project. Use the Reference Manager tool to manually browse to this dll and add it to your project. I prefer to take one from the bin folder in my “Database” project for ease but you might want to place it in a folder dedicated to sharing dll’s in your project.</p>\n<p>Add a reference to the EntityFramework.SqlServer dll</p>\n<p>Once this is done, you can now use the database with your existing model. But what happens when we want to add a field <code class="language-text">Author</code> to it? Our Migrations configuration is dead so we’ll have to fix that first.</p>\n<h2>Update the model.</h2>\n<p>We’ll slightly update our <code class="language-text">Book</code> model to account for an optional <code class="language-text">Author</code> parameter like this:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Book</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token function">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token function">Book</span><span class="token punctuation">(</span><span class="token keyword">string</span> title<span class="token punctuation">,</span> <span class="token keyword">string</span> author <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        Title <span class="token operator">=</span> title<span class="token punctuation">;</span>\n        Author <span class="token operator">=</span> author<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">int</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n    <span class="token keyword">public</span> <span class="token keyword">string</span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n    <span class="token keyword">public</span> <span class="token keyword">string</span> Author <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<h2>Re-configuring Migrations</h2>\n<p>You’ll notice that if you now try to add a new migration, the Package Manager Console will only display errors: “The EntityFramework package is not installed on project ‘Migrations’.” and “No migrations configuration type was found in the assembly ‘Database’” depending on which project you target with your command.</p>\n<p>First of all: install Entity-Framework in the Migrations project. If you now try to call <code class="language-text">Enable-Migrations</code> it will tell you that it can’t find a context type inside this project (which is true, it’s in our “Database” project). Luckily we can specify the project in which it should look!</p>\n<p>If you now use <code class="language-text">Enable-Migrations -ContextProjectName &quot;Database&quot; -Force</code> it will configure Migrations with the context it finds in “Database”. The -Force is there to overwrite the existing Migration we moved to the Migrations project.</p>\n<p>We can now add our changes using <code class="language-text">Add-Migration &quot;author field&quot;</code> and a subsequent <code class="language-text">Update-Database</code>.</p>\n<p>Looking at the database we can see it added a new column to it.\nIf we change our console application a little bit to insert a book with an author specified, we see it works perfectly:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LibraryContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> bookRepository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookRepository</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    bookRepository<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Book</span><span class="token punctuation">(</span><span class="token string">"American Psycho"</span><span class="token punctuation">,</span> <span class="token string">"Bret Easton Ellis"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">"\\n"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span>Author <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> x<span class="token punctuation">.</span>Title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    Console<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/second-author-added-dc6854b578ea726e23bc5a33f21de50d-25fd1.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 320px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 21.5625%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAu0lEQVQY03WOS4+CQBCE+f+/a89eNvgAYWRRokPDaBgeEeSzZQ97cK2kUoeq6urA+5brrWEdGbK8IEkSojghz09k2Q9pahbd7SLSQ8Y+3mPLktKGhOEX41QAF+WZx6MiqJ2jbTuOxZmqqrQQLyWjhxY1ZvG997SdauOZxjunY8R2s9LhrQ4YzX/T9VeC5hWYJoZhYNSglIK1lrp2iAiiIzPvcPVNc0Khj4g41Qt9fyf4tf+r/GGe5zd+whOGnjCs48YtQQAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="Second author added"\n        title=""\n        src="/static/second-author-added-dc6854b578ea726e23bc5a33f21de50d-25fd1.png"\n        srcset="/static/second-author-added-dc6854b578ea726e23bc5a33f21de50d-c5c55.png 240w,\n/static/second-author-added-dc6854b578ea726e23bc5a33f21de50d-25fd1.png 320w"\n        sizes="(max-width: 320px) 100vw, 320px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>In order to verify our tests still work just fine we add a fourth that tests whether a book with author can be inserted:</p>\n<div class="gatsby-highlight">\n      <pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token class-name">TestMethod</span><span class="token punctuation">]</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">InsertBook_WithAuthor_SavesAuthorInDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token comment">// Arrange</span>\n    <span class="token keyword">const</span> <span class="token keyword">string</span> author <span class="token operator">=</span> <span class="token string">"Bret Easton Ellis"</span><span class="token punctuation">;</span>\n    <span class="token keyword">var</span> book <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Book</span><span class="token punctuation">(</span><span class="token string">"American Psycho"</span><span class="token punctuation">,</span> author<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Act</span>\n    _repository<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// Assert</span>\n    _context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HaveCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    _context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Author<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NotBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    _context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Author<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NotBeEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    _context<span class="token punctuation">.</span>Books<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Author<span class="token punctuation">.</span><span class="token function">Should</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Be</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></code></pre>\n      </div>\n<p>Lo and behold: all tests pass without having to change anything in the test project; we can immediately test the changes in our model. Also notice how incredibly quick the tests have finished, taking into account that we basically recreated the database 4 times. Aside from a little warmup time, tests are executed pretty much instantly.</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/tests-ae508267fad80c0f88e42a5eec6f4d69-3bef9.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 768px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 14.713541666666666%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAkUlEQVQI14WOMQrCQBBFc13voaIgiIJWsbKy0gMIypY2tmqzJlmwEcTdDcgG57nBNELAD2/4MMNjkvPlhCkM3jvK0uOco6oCdUSkng1tkeYGQgikyw2JNhnG3NBZjtZX8ih/PC1v4Y/sV2jjI7N0RdLd3pkqz0Q5RjvLOPbFEeYHoa+ISAMtfHe92Af7F53hmg/F3Nqu2EUK3AAAAABJRU5ErkJggg==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="Tests passed"\n        title=""\n        src="/static/tests-ae508267fad80c0f88e42a5eec6f4d69-3bef9.png"\n        srcset="/static/tests-ae508267fad80c0f88e42a5eec6f4d69-4f55c.png 240w,\n/static/tests-ae508267fad80c0f88e42a5eec6f4d69-7c32b.png 480w,\n/static/tests-ae508267fad80c0f88e42a5eec6f4d69-3bef9.png 768w"\n        sizes="(max-width: 768px) 100vw, 768px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h1>Conclusion</h1>\n<p>This article describes how you can create an in-memory database identical to the one in production and use it to test your exact interaction. Whether or not that is something you should want to do in the first place is up to you but I believe it very useful, certainly when there is more complicated logic inside your repositories. This is an important piece of code that should be tested but mocking is brittle at best in my eyes.</p>\n<p>You can tell from the tests I’ve shown that there is very, very little noise in your tests which is an entirely different thing when you have to use mocks to return the correct data from every method call. It also prevents you from forgetting about mocking certain intertwined method calls which would then suddenly return faulty data because they use an actual implementation rather than one controlled by your testing environment. Effort makes sure this isn’t an issue since your entire test environment is under control by default.</p>\n<p>If you’re interested in empirical evidence: I’ve used this in a small ASP.NET Web Api project with around 300 end-to-end tests (REST call comes in -> Interact with database -> Return data). Each of these tests created a new isolated database, interacted with it in some way and verified the responses that were returned. The overall execution time of the test suite was around 5 seconds.</p>\n<p>All things considered I am a big fan of using this method to bypass mocks and verify the interaction with the database works as it should.</p>',
fields:{tagSlugs:["/tags/c/","/tags/entity-framework/","/tags/unit-testing/"]},frontmatter:{title:"Properly testing Entity-Framework with Effort",tags:["C#","Entity-Framework","Unit Testing"],date:"2015-02-26T00:00:00.000Z",description:"An introduction to testing your EF logic"}}},pathContext:{slug:"/posts/properly-testing-entity-framework-with-effort/"}}}});
//# sourceMappingURL=path---posts-properly-testing-entity-framework-with-effort-4f552f6c7f49b364f220.js.map